name: Setup New Repository

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Check if setup is needed
        id: check
        run: |
          if grep -r "{{PROJECT_NAME}}" . 2>/dev/null || grep -r "{{PACKAGE_NAME}}" . 2>/dev/null; then
            echo "needs_setup=true" >> $GITHUB_OUTPUT
            echo "âœ… Placeholders encontrados, executando setup..."
          else
            echo "needs_setup=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhum placeholder encontrado, pulando setup."
          fi

      - name: Setup repository
        if: steps.check.outputs.needs_setup == 'true'
        run: |
          # Pega o nome do repositÃ³rio
          REPO_NAME="${GITHUB_REPOSITORY##*/}"

          # Converte para nome vÃ¡lido do npm
          PACKAGE_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

          echo "ðŸ“¦ RepositÃ³rio: $REPO_NAME"
          echo "ðŸ“ Nome do pacote: $PACKAGE_NAME"

          # Substitui placeholders em todos os arquivos
          find . -type f \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -not -path "./.github/workflows/setup.yml" \
            -print0 | while IFS= read -r -d '' file; do
              if [ -f "$file" ]; then
                sed -i "s/{{PROJECT_NAME}}/$REPO_NAME/g" "$file" 2>/dev/null || true
                sed -i "s/{{PACKAGE_NAME}}/$PACKAGE_NAME/g" "$file" 2>/dev/null || true
              fi
            done

          echo "âœ… Setup completo!"

      - name: Remove setup workflow
        if: steps.check.outputs.needs_setup == 'true'
        run: rm -f .github/workflows/setup.yml

      - name: Commit changes
        if: steps.check.outputs.needs_setup == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "chore: initialize project with correct name"
          git push
