name: Setup New Repository

on:
  push:
    branches:
      - main
      - master

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Check if setup is needed
        id: check
        run: |
          if grep -q "{{PROJECT_NAME}}" package.json 2>/dev/null || grep -q "{{PACKAGE_NAME}}" package.json 2>/dev/null; then
            echo "needs_setup=true" >> $GITHUB_OUTPUT
          else
            echo "needs_setup=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup repository
        if: steps.check.outputs.needs_setup == 'true'
        run: |
          # Pega o nome do reposit√≥rio
          REPO_NAME="${GITHUB_REPOSITORY##*/}"

          # Converte para nome v√°lido do npm
          PACKAGE_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

          echo "üì¶ Reposit√≥rio: $REPO_NAME"
          echo "üìù Nome do pacote: $PACKAGE_NAME"

          # Substitui placeholders
          find . -type f \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -not -path "./.github/workflows/setup.yml" \
            -exec sed -i "s/{{PROJECT_NAME}}/$REPO_NAME/g" {} + \
            -exec sed -i "s/{{PACKAGE_NAME}}/$PACKAGE_NAME/g" {} +

          echo "‚úÖ Setup completo!"

      - name: Remove setup workflow
        if: steps.check.outputs.needs_setup == 'true'
        run: rm -f .github/workflows/setup.yml

      - name: Commit changes
        if: steps.check.outputs.needs_setup == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: initialize project" || echo "No changes"
          git push
